<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" href="./assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" href="./assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" href="./assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="manifest" href="./manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        var scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          var element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          var hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          var newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((entries) => {
          setHeight();
        });
        resizeObserver.observe(obj.contentWindow.document.body);
      }
    </script>
    <marimo-filename hidden>notebook.py</marimo-filename>
    <!-- TODO(Trevor): Legacy, required by VS Code plugin. Remove when plugin is updated (see marimo/server/_templates/template.py) -->
    <marimo-version data-version="{{ version }}" hidden></marimo-version>
    <marimo-user-config data-config="{{ user_config }}" hidden></marimo-user-config>
    <marimo-server-token data-token="{{ server_token }}" hidden></marimo-server-token>
    <!-- /TODO -->
    <title>fee model</title>
    <script type="module" crossorigin src="./assets/index-CelXfcd8.js"></script>
    <link rel="stylesheet" crossorigin href="./assets/index-CGDMlQfO.css">
  <marimo-wasm hidden=""></marimo-wasm>
    <script>
        if (window.location.protocol === 'file:') {
            alert('Warning: This file must be served by an HTTP server to function correctly.');
        }
    </script>
    
    <style>
        #save-button {
            display: none !important;
        }
        #filename-input {
            display: none !important;
        }
    </style>
    <marimo-code hidden="">import%20marimo%0A%0A__generated_with%20%3D%20%220.16.2%22%0Aapp%20%3D%20marimo.App(width%3D%22medium%22)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20micropip%0A%20%20%20%20return%20(micropip%2C)%0A%0A%0A%40app.cell%0Aasync%20def%20_(micropip)%3A%0A%20%20%20%20await%20micropip.install(%22altair%22)%0A%20%20%20%20await%20micropip.install(%22openpyxl%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%20%0A%20%20%20%20import%20pandas%20as%20pd%20%0A%20%20%20%20import%20numpy%20as%20np%0A%20%20%20%20import%20altair%20as%20alt%0A%20%20%20%20import%20os%20%0A%20%20%20%20return%20alt%2C%20mo%2C%20np%2C%20pd%0A%0A%0A%40app.cell%0Adef%20_(mo%2C%20pd)%3A%0A%20%20%20%20fee_data%20%3D%20pd.read_excel(str(mo.notebook_location()%20%2F%20'public'%20%2F%20'fee_data.xlsx'))%0A%20%20%20%20return%20(fee_data%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%20Simulation%20of%20PAYT%20reform%0A%0A%20%20%20%20In%20this%20notebook%20we%20can%20simulate%20impacts%20of%20waste%20collection%20reforms%20on%20tax%20revenue%20and%20expenditures%20of%20OLO.%20%0A%20%20%20%20We%20will%20adjust%20different%20parameters%20to%20show%20the%20expected%20evolution%20of%20key%20indicators%20in%20various%20scenarios.%20Since%20we%20have%20little%20available%20past%20data%20on%20how%20people%20in%20Bratislava%20respond%20to%20changes%20in%20waste%20collection%2C%20we%20need%20to%20model%20different%20scenarios%20to%20show%20a%20potential%20range%20of%20outcomes.%20%0A%0A%20%20%20%20Here%20you%20can%20set%20up%20the%20simulation%3A%20%0A%0A%20%20%20%201.%20Increase%20in%20fees%20(in%20%25)%0A%20%20%20%202.%20Removing%20%2F%20adding%20options%20of%20collection%20schedules%0A%0A%20%20%20%20The%20simulation%20is%20parametrized%20differently%20for%20individual%20homes%20and%20differently%20for%20businesses%2Fcoops.%20This%20is%20because%20the%20assumption%20is%20that%20these%20groups%20respond%20differently%20to%20fee%20increases.%20While%20individual%20home%20owners%20can%20respond%20by%20frequency%20changes%20only%20(usually%20only%20have%20on%20bin)%2C%20coops%20and%20businesses%20mostly%20adjust%20the%20number%20of%20bins%2C%20and%20only%20if%20this%20is%20not%20an%20option%20do%20they%20drop%20frequencies.%20%0A%0A%20%20%20%20You%20can%20setup%20a%20simple%20model%20(one%20%25%20fee%20increase)%20or%20a%20stepped%20model%20where%20we%20can%20schedule%20several%20adjustments%20to%20fees%20over%20time.%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo%2C%20pd)%3A%0A%20%20%20%20fee_hike%20%3D%20mo.ui.slider(0%2C100%2C%20show_value%3DTrue%2C%20include_input%3DTrue%2C%20value%3D30)%0A%20%20%20%20remove_weekly%20%3D%20mo.ui.checkbox()%0A%20%20%20%20forecast_periods%20%3D%20mo.ui.slider(0%2C20%2C%20show_value%3DTrue%2C%20include_input%3DTrue%2C%20value%3D5)%0A%0A%20%20%20%20ind_setup_df%20%3D%20pd.DataFrame(columns%3D%5B'Fee%20Hike'%2C'Year%20Gap'%2C'Disable%20Weekly%20Option'%5D%2C%20data%3D%5B%5B30%2C5%2CFalse%5D%5D)%0A%20%20%20%20ind_setup_editor%20%3D%20mo.ui.data_editor(data%3Dind_setup_df)%0A%0A%20%20%20%20fee_hike_coop%20%3D%20mo.ui.slider(0%2C100%2C%20show_value%3DTrue%2C%20include_input%3DTrue%2C%20value%3D30)%0A%20%20%20%20forecast_periods_coop%20%3D%20mo.ui.slider(0%2C20%2C%20show_value%3DTrue%2C%20include_input%3DTrue%2C%20value%3D5)%0A%0A%20%20%20%20coop_setup_df%20%3D%20pd.DataFrame(columns%3D%5B'Fee%20Hike'%2C'Year%20Gap'%5D%2C%20data%3D%5B%5B30%2C5%5D%5D)%0A%20%20%20%20coop_setup_editor%20%3D%20mo.ui.data_editor(data%3Dcoop_setup_df)%0A%0A%20%20%20%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20mo.md('%23%23%20Parameter%20setup')%2C%0A%20%20%20%20%20%20%20%20mo.md('%23%23%23%20Individual%20homes%20(simple%20setup)')%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bmo.md('**1%20Increase%20in%20standard%20fee%20in%20%25**')%2C%20fee_hike%5D%2C%20align%3D'center')%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bmo.md('**2%20Disable%20once%20per%20week%20frequency%20option%20for%20individual%20homes**')%2C%20remove_weekly%5D%2C%20%20align%3D'center')%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bmo.md('**3%20Number%20of%20years%20to%20forecast**')%2C%20forecast_periods%5D%2C%20align%3D'center')%2C%0A%20%20%20%20%20%20%20%20mo.md('%23%23%23%20Individual%20homes%20(complex%20setup)')%2C%0A%20%20%20%20%20%20%20%20mo.md('In%20this%20table%2C%20you%20can%20add%20multiple%20rows%20as%20steps%20in%20gradual%20fee%20increase%20%2F%20change')%2C%0A%20%20%20%20%20%20%20%20ind_setup_editor%2C%0A%20%20%20%20%20%20%20%20mo.md('%23%23%23%20Coops%2Fbusinesses%20(simple%20setup)')%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bmo.md('**1%20Increase%20in%20standard%20fee%20in%20%25**')%2C%20fee_hike_coop%5D%2C%20align%3D'center')%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bmo.md('**2%20Number%20of%20years%20to%20forecast**')%2C%20forecast_periods_coop%5D%2C%20align%3D'center')%2C%0A%20%20%20%20%20%20%20%20mo.md('%23%23%23%20Coops%2Fbusinesses%20(complex%20setup)')%2C%0A%20%20%20%20%20%20%20%20coop_setup_editor%0A%0A%20%20%20%20%5D)%0A%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20coop_setup_editor%2C%0A%20%20%20%20%20%20%20%20fee_hike%2C%0A%20%20%20%20%20%20%20%20fee_hike_coop%2C%0A%20%20%20%20%20%20%20%20forecast_periods%2C%0A%20%20%20%20%20%20%20%20forecast_periods_coop%2C%0A%20%20%20%20%20%20%20%20ind_setup_editor%2C%0A%20%20%20%20%20%20%20%20remove_weekly%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(alt%2C%20ind_df_results%2C%20mo)%3A%0A%20%20%20%20ind_fee_chart%20%3D%20mo.ui.altair_chart(alt.Chart(ind_df_results).mark_trail().encode(x%3D'Period'%2C%20y%3D%22Individual%20payers%20fees%22%2C%20color%3D'Scenario')%2C%20label%3D%22Evolution%20of%20fees%20from%20individual%20payers%20in%20EUR%22)%0A%0A%20%20%20%20ind_bin_chart%20%3D%20mo.ui.altair_chart(alt.Chart(ind_df_results).mark_trail().encode(x%3D'Period'%2C%20y%3D%22Individual%20bin%20count%22%2C%20color%3D'Scenario')%2C%20label%3D%22Evolution%20of%20%23%20of%20bins%20from%20individual%20payers%22)%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20ind_bin_chart%2C%0A%20%20%20%20%20%20%20%20ind_fee_chart%0A%20%20%20%20%5D)%0A%20%20%20%20%22%22%22%0A%20%20%20%20ind_fee_chart%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(alt%2C%20coop_results_%2C%20mo)%3A%0A%20%20%20%20coop_fee_chart%20%3D%20mo.ui.altair_chart(alt.Chart(coop_results_).mark_trail().encode(x%3D'Period'%2C%20y%3D%22Coop%20fees%22%2C%20color%3D'Scenario')%2C%20label%3D%22Evolution%20of%20fees%20from%20coop%20and%20business%20payers%20in%20EUR%22)%0A%0A%20%20%20%20coop_bin_chart%20%3D%20mo.ui.altair_chart(alt.Chart(coop_results_).mark_trail().encode(x%3D'Period'%2C%20y%3D%22Coop%20bin%20count%22%2C%20color%3D'Scenario')%2C%20label%3D%22Evolution%20of%20%23%20of%20bins%20for%20coop%20and%20business%20payers%22)%0A%0A%20%20%20%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20coop_fee_chart%2C%0A%20%20%20%20%20%20%20%20coop_bin_chart%0A%20%20%20%20%5D)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(fee_data)%3A%0A%20%20%20%20%23%20basic%20groupings%20of%20current%20data%0A%20%20%20%20grouped_overview%20%3D%20fee_data.groupby(%5B'Year'%2C'Payer'%2C'CapacityInt'%5D%2C%20as_index%3DFalse)%5B%5B'BinCount'%2C'TotalFee'%2C'TotalWeeklyVolume'%2C'CollectionPoints'%5D%5D.sum()%0A%20%20%20%20bin_count_overview%20%3D%20grouped_overview.pivot(columns%3D'Year'%2Cindex%3D%5B'Payer'%2C'CapacityInt'%5D%2Cvalues%3D%5B'BinCount'%5D)%0A%20%20%20%20fee_overview%20%3D%20grouped_overview.pivot(columns%3D'Year'%2Cindex%3D%5B'Payer'%2C'CapacityInt'%5D%2Cvalues%3D%5B'TotalFee'%5D)%0A%20%20%20%20volume_overview%20%3D%20grouped_overview.pivot(columns%3D'Year'%2Cindex%3D%5B'Payer'%2C'CapacityInt'%5D%2Cvalues%3D%5B'TotalWeeklyVolume'%5D)%0A%0A%20%20%20%20big_grouped_overview%20%3D%20fee_data.groupby(%5B'Year'%2C'Payer'%5D%2C%20as_index%3DFalse)%5B%5B'BinCount'%2C'TotalFee'%2C'TotalWeeklyVolume'%2C'CollectionPoints'%5D%5D.sum()%0A%0A%20%20%20%20big_grouped_overview%5B'BinsPerPoint'%5D%20%3D%20big_grouped_overview.BinCount.div(big_grouped_overview.CollectionPoints)%0A%20%20%20%20grouped_overview%5B'BinsPerPoint'%5D%20%3D%20grouped_overview.BinCount.div(grouped_overview.CollectionPoints)%0A%20%20%20%20grouped_overview%5B'PayerCapacity'%5D%20%3D%20grouped_overview.Payer%20%2B%20grouped_overview.CapacityInt.astype(str)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(fee_data%2C%20fee_hike_coop)%3A%0A%20%20%20%20%23%20get%20baseline%20for%20coops%20and%20businesses%20homes%0A%20%20%20%20coop_sample%20%3D%20fee_data.query('Payer%20!%3D%20%22Individual%22')%0A%20%20%20%20coop_baseline%20%3D%20coop_sample.query('Year%20%3D%3D%202025').groupby(%5B'IntervalPerWeek'%5D%2C%20as_index%3DFalse)%5B%5B'CollectionPoints'%2C'BinCount'%2C'TotalFee'%2C'TotalVolume'%5D%5D.sum()%0A%20%20%20%20coop_baseline%5B'FeePerBin'%5D%20%3D%20coop_baseline%5B'TotalFee'%5D.div(coop_baseline%5B'BinCount'%5D)%0A%20%20%20%20coop_baseline%5B'BinPerPoint'%5D%20%3D%20coop_baseline%5B'BinCount'%5D.div(coop_baseline%5B'CollectionPoints'%5D)%0A%0A%20%20%20%20coop_old_fees%20%3D%20coop_baseline%5B%5B'FeePerBin'%5D%5D.values%0A%20%20%20%20coop_old_bin_ratio%20%3D%20coop_baseline%5B%5B'BinPerPoint'%5D%5D.values%0A%20%20%20%20coop_old_points%20%3D%20coop_baseline%5B%5B'CollectionPoints'%5D%5D.values%0A%0A%20%20%20%20coop_fee_hike_pct%20%3D%20fee_hike_coop.value%2F100.%20%0A%20%20%20%20coop_new_fees%20%3D%20coop_old_fees%20*%20(1%20%2B%20coop_fee_hike_pct)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20coop_fee_hike_pct%2C%0A%20%20%20%20%20%20%20%20coop_new_fees%2C%0A%20%20%20%20%20%20%20%20coop_old_bin_ratio%2C%0A%20%20%20%20%20%20%20%20coop_old_fees%2C%0A%20%20%20%20%20%20%20%20coop_old_points%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20bin_per_point_forecast%2C%0A%20%20%20%20coop_fee_hike_pct%2C%0A%20%20%20%20coop_new_fees%2C%0A%20%20%20%20coop_old_bin_ratio%2C%0A%20%20%20%20coop_old_fees%2C%0A%20%20%20%20coop_old_points%2C%0A%20%20%20%20forecast_periods_coop%2C%0A%20%20%20%20np%2C%0A%20%20%20%20pd%2C%0A)%3A%0A%20%20%20%20simple_coop_forecast_bins%2C%20latest_sample%20%3D%20bin_per_point_forecast(coop_old_bin_ratio%2C%20coop_old_points%2C%20coop_fee_hike_pct%2C%20forecast_periods_coop.value)%0A%20%20%20%20simple_coop_forecast_fees%20%3D%20simple_coop_forecast_bins%20*%20coop_new_fees.T%0A%20%20%20%20simple_coop_forecast_fees%5B0%5D%20%3D%20simple_coop_forecast_bins%5B0%5D%20*%20coop_old_fees.T%20%0A%20%20%20%20simple_coop_forecast_fees%0A%0A%20%20%20%20coop_results%20%3D%20pd.DataFrame(%7B'Coop%20fees'%3A%20simple_coop_forecast_fees.sum(axis%3D1)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Coop%20bin%20count'%3A%20simple_coop_forecast_bins.sum(axis%3D1)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Period'%3A%20np.arange(forecast_periods_coop.value)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Scenario'%3A%20'Simple'%7D)%0A%20%20%20%20return%20(coop_results%2C)%0A%0A%0A%40app.cell%0Adef%20_(coop_results%2C%20np%2C%20pd%2C%20stepped_coop)%3A%0A%20%20%20%20stepped_coop_bins%2C%20stepped_coop_fees%20%3D%20stepped_coop()%0A%20%20%20%20stepped_coop_bins_total%20%3D%20stepped_coop_bins.sum(axis%3D1)%0A%20%20%20%20stepped_coop_fees_total%20%3D%20stepped_coop_fees.sum(axis%3D1)%0A%0A%20%20%20%20coop_results2%20%3D%20pd.DataFrame(%0A%20%20%20%20%20%20%20%20%7B'Coop%20fees'%3A%20stepped_coop_fees_total%2C%0A%20%20%20%20%20%20%20%20%20'Coop%20bin%20count'%3A%20stepped_coop_bins_total%2C%0A%20%20%20%20%20%20%20%20%20'Period'%3A%20np.arange(len(stepped_coop_fees_total))%2C%0A%20%20%20%20%20%20%20%20%20'Scenario'%3A%20'Stepped%20model'%7D)%0A%0A%20%20%20%20coop_results_%20%3D%20pd.concat(%5Bcoop_results%2C%20coop_results2%5D%2C%20ignore_index%3DTrue)%0A%20%20%20%20return%20(coop_results_%2C)%0A%0A%0A%40app.cell%0Adef%20_(fee_data)%3A%0A%20%20%20%20%23%20get%20baseline%20for%20individual%20homes%0A%20%20%20%20individual_sample%20%3D%20fee_data.query('Payer%20%3D%3D%20%22Individual%22%20and%20IntervalPerWeek%20%3C%202%20and%20CapacityInt%20%3C%201000')%0A%20%20%20%20ind_baseline%20%3D%20individual_sample.query('Year%20%3D%3D%202025')%5B%5B'CapacityInt'%2C'IntervalPerWeek'%2C'CollectionPoints'%2C'BinCount'%2C'TotalFee'%2C'TotalVolume'%5D%5D%0A%20%20%20%20ind_baseline%5B'FeePerBin'%5D%20%3D%20ind_baseline%5B'TotalFee'%5D.div(ind_baseline%5B'BinCount'%5D)%0A%20%20%20%20return%20(ind_baseline%2C)%0A%0A%0A%40app.cell%0Adef%20_(fee_hike%2C%20ind_baseline)%3A%0A%20%20%20%20%23%20get%20baseline%20for%20bins%20and%20fees%20for%20homes%0A%20%20%20%20ind_fee_hike_pct%20%3D%20fee_hike.value%2F100.%0A%20%20%20%20ind_old_fees%20%3D%20ind_baseline%5B%5B'FeePerBin'%5D%5D.values%20%0A%20%20%20%20ind_baseline_bins%20%3D%20ind_baseline%5B%5B'BinCount'%5D%5D.values.T%0A%20%20%20%20ind_new_fees%20%3D%20ind_old_fees%20*%20(1.%20%2B%20ind_fee_hike_pct)%0A%20%20%20%20return%20ind_baseline_bins%2C%20ind_fee_hike_pct%2C%20ind_new_fees%2C%20ind_old_fees%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20forecast_periods%2C%0A%20%20%20%20ind_baseline_bins%2C%0A%20%20%20%20ind_fee_hike_pct%2C%0A%20%20%20%20ind_new_fees%2C%0A%20%20%20%20ind_old_fees%2C%0A%20%20%20%20remove_weekly%2C%0A%20%20%20%20run_individual%2C%0A)%3A%0A%20%20%20%20%23%20forecast%20individual%20homes%0A%20%20%20%20ind_bin_evolution%20%3D%20run_individual(ind_baseline_bins%2C%20forecast_periods.value%2C%200%2C%20price_increase%3Dind_fee_hike_pct%2C%20remove_weekly%3Dremove_weekly.value)%0A%20%20%20%20ind_fee_evolution%20%3D%20ind_bin_evolution%20*%20ind_new_fees.T%0A%20%20%20%20ind_fee_evolution%5B0%5D%20%3D%20ind_bin_evolution%5B0%5D%20*%20ind_old_fees.T%20%23%20first%20year%20keeps%20old%20fees%0A%20%20%20%20return%20ind_bin_evolution%2C%20ind_fee_evolution%0A%0A%0A%40app.cell%0Adef%20_(ind_bin_evolution%2C%20ind_fee_evolution)%3A%0A%20%20%20%20ind_fee_evolution_total%20%3D%20ind_fee_evolution.sum(axis%3D1)%0A%20%20%20%20ind_bin_evolution_total%20%3D%20ind_bin_evolution.sum(axis%3D1)%0A%20%20%20%20return%20ind_bin_evolution_total%2C%20ind_fee_evolution_total%0A%0A%0A%40app.cell%0Adef%20_(ind_baseline_bins%2C%20ind_old_fees%2C%20ind_setup_editor%2C%20np%2C%20run_individual)%3A%0A%20%20%20%20def%20stepped_individual()%3A%0A%0A%20%20%20%20%20%20%20%20old_fees%20%3D%20ind_old_fees.copy()%20%0A%20%20%20%20%20%20%20%20baseline_bins%20%3D%20ind_baseline_bins.copy()%20%0A%20%20%20%20%20%20%20%20bin_evolution%20%3D%20np.array(%5B%5D)%0A%20%20%20%20%20%20%20%20fee_evolution%20%3D%20np.array(%5B%5D)%0A%20%20%20%20%20%20%20%20price_hike%20%3D%200.%0A%0A%20%20%20%20%20%20%20%20for%20step%20in%20ind_setup_editor.value.iterrows()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20step_values%20%3D%20step%5B1%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20price_hike%20%3D%20price_hike%20%2B%20(step_values%5B'Fee%20Hike'%5D%20%2F%20100.)%0A%20%20%20%20%20%20%20%20%20%20%20%20_new_fees%20%3D%20old_fees%20*%20(1%20%2B%20price_hike)%0A%20%20%20%20%20%20%20%20%20%20%20%20_evolution%20%3D%20run_individual(baseline_bins%2C%20step_values%5B'Year%20Gap'%5D%2C%200%2C%20price_increase%20%3D%20price_hike%2C%20remove_weekly%20%3D%20step_values%5B'Disable%20Weekly%20Option'%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20_fee_evolution%20%3D%20_evolution%20*%20_new_fees.T%20%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20len(bin_evolution)%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_fee_evolution%5B0%5D%20%3D%20_evolution%5B0%5D%20*%20old_fees.T%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20bin_evolution%20%3D%20_evolution%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fee_evolution%20%3D%20_fee_evolution%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_fee_evolution%20%3D%20_fee_evolution%5B1%3A%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_evolution%20%3D%20_evolution%5B1%3A%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20bin_evolution%20%3D%20np.concatenate(%5Bbin_evolution%2C%20_evolution%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fee_evolution%20%3D%20np.concatenate(%5Bfee_evolution%2C%20_fee_evolution%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20baseline_bins%20%3D%20np.array(%5B_evolution%5B-1%5D%5D)%0A%0A%20%20%20%20%20%20%20%20return%20bin_evolution%2C%20fee_evolution%0A%0A%20%20%20%20stepped_ind_bins%2C%20stepped_ind_fees%20%3D%20stepped_individual()%0A%20%20%20%20stepped_ind_bins_total%20%3D%20stepped_ind_bins.sum(axis%3D1)%0A%20%20%20%20stepped_ind_fees_total%20%3D%20stepped_ind_fees.sum(axis%3D1)%0A%20%20%20%20return%20stepped_ind_bins_total%2C%20stepped_ind_fees_total%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20forecast_periods%2C%0A%20%20%20%20ind_bin_evolution_total%2C%0A%20%20%20%20ind_fee_evolution_total%2C%0A%20%20%20%20np%2C%0A%20%20%20%20pd%2C%0A%20%20%20%20stepped_ind_bins_total%2C%0A%20%20%20%20stepped_ind_fees_total%2C%0A)%3A%0A%20%20%20%20_ind_df_results%20%3D%20pd.DataFrame(%0A%20%20%20%20%20%20%20%20%7B'Individual%20payers%20fees'%3A%20ind_fee_evolution_total%2C%0A%20%20%20%20%20%20%20%20%20'Individual%20bin%20count'%3A%20ind_bin_evolution_total%2C%0A%20%20%20%20%20%20%20%20%20'Period'%3A%20np.arange(forecast_periods.value%2B1)%2C%0A%20%20%20%20%20%20%20%20%20'Scenario'%3A%20'Simple%20model'%7D)%0A%0A%20%20%20%20_ind_df_results2%20%3D%20pd.DataFrame(%0A%20%20%20%20%20%20%20%20%7B'Individual%20payers%20fees'%3A%20stepped_ind_fees_total%2C%0A%20%20%20%20%20%20%20%20%20'Individual%20bin%20count'%3A%20stepped_ind_bins_total%2C%0A%20%20%20%20%20%20%20%20%20'Period'%3A%20np.arange(len(stepped_ind_fees_total))%2C%0A%20%20%20%20%20%20%20%20%20'Scenario'%3A%20'Stepped%20model'%7D)%0A%0A%20%20%20%20ind_df_results%20%3D%20pd.concat(%5B_ind_df_results%2C%20_ind_df_results2%5D)%0A%20%20%20%20return%20(ind_df_results%2C)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20coop_old_bin_ratio%2C%0A%20%20%20%20coop_old_fees%2C%0A%20%20%20%20coop_old_points%2C%0A%20%20%20%20coop_setup_editor%2C%0A%20%20%20%20np%2C%0A)%3A%0A%20%20%20%20def%20bin_count_response(price_increase%3A%20float%2C%20period%3Aint%2C%20scale%3A%20float%20%3D%206.0)%3A%0A%0A%20%20%20%20%20%20%20%20if%20period%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%201%0A%0A%20%20%20%20%20%20%20%20return%201%20-%20(price_increase%20%2F%20(scale%20**%20period))%0A%0A%20%20%20%20def%20bin_per_point_forecast(initial_state%3A%20np.array%2C%20point_count%3A%20np.array%2C%20price_increase%3A%20float%2C%20periods%3A%20int)%3A%0A%0A%20%20%20%20%20%20%20%20%23%20for%20each%20period%20do%20this%3A%0A%20%20%20%20%20%20%20%20%23%23%20get%20bin_count_response%20for%20given%20period%20and%20price%20increase%0A%20%20%20%20%20%20%20%20%23%23%20multiply%20initial_state%20by%20this%20factor%20%3D%20new_state%0A%20%20%20%20%20%20%20%20%23%23%20multiply%20point_count%20by%20new_state%0A%20%20%20%20%20%20%20%20%23%23%20if%20there%20are%20any%20values%20%3C%201%20in%20new_state%2C%20move%20the%20difference%20of%201%20-%20new_state%20to%20lower%20frequency%20%0A%20%20%20%20%20%20%20%20%23%23%20adjust%20bins%20per%20point%20to%201%20for%20those%20where%20it%20was%20%3C%201%0A%20%20%20%20%20%20%20%20%23%23%20repeat%20%0A%0A%20%20%20%20%20%20%20%20%23%23%20shape%20of%20initial_state%20%3D%20(1%2C%20n)%20where%20n%20is%20number%20of%20possible%20frequencies%0A%20%20%20%20%20%20%20%20%23%23%20shape%20of%20point_count%20%3D%20(1%2C%20n)%20where%20n%20is%20number%20of%20possible%20frequencies%0A%20%20%20%20%20%20%20%20%23%23%20%0A%0A%20%20%20%20%20%20%20%20bin_count_history%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20for%20period%20in%20range(periods)%3A%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20_factor%20%3D%20bin_count_response(price_increase%2C%20period)%0A%20%20%20%20%20%20%20%20%20%20%20%20new_state%20%3D%20initial_state%20*%20_factor%20%0A%20%20%20%20%20%20%20%20%20%20%20%20below_one%20%3D%20new_state%20%3C%201%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20np.any(below_one)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20below_one_delta%20%3D%20np.maximum(0%2C%201%20-%20new_state)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20point_shift%20%3D%20point_count%20*%20below_one_delta%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20rolled_point_shift%20%3D%20np.roll(point_shift%2C%20-1)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20new_bins%20%3D%20(point_count%20*%20new_state)%20%2B%20rolled_point_shift%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20point_count%20%3D%20point_count%20%2B%20rolled_point_shift%20-%20point_shift%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20new_state%20%3D%20new_bins%20%2F%20point_count%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20new_bins%20%3D%20point_count%20*%20new_state%20%23%20dimensions%20possibly%20need%20to%20be%20adjusted%20%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20len(bin_count_history)%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20bin_count_history%20%3D%20new_bins.T%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20bin_count_history%20%3D%20np.concatenate(%5Bbin_count_history%2C%20new_bins.T%5D)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20initial_state%20%3D%20new_state%0A%0A%20%20%20%20%20%20%20%20return%20bin_count_history%2C%20new_state%0A%0A%0A%20%20%20%20def%20stepped_coop()%3A%0A%0A%20%20%20%20%20%20%20%20old_fees%20%3D%20coop_old_fees.copy()%20%0A%20%20%20%20%20%20%20%20baseline_points%20%3D%20coop_old_points.copy()%20%0A%20%20%20%20%20%20%20%20baseline_ratio%20%3D%20coop_old_bin_ratio.copy()%0A%20%20%20%20%20%20%20%20bin_evolution%20%3D%20np.array(%5B%5D)%0A%20%20%20%20%20%20%20%20fee_evolution%20%3D%20np.array(%5B%5D)%0A%20%20%20%20%20%20%20%20price_hike%20%3D%200.%0A%0A%20%20%20%20%20%20%20%20for%20step%20in%20coop_setup_editor.value.iterrows()%3A%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20step_values%20%3D%20step%5B1%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20price_hike%20%3D%20price_hike%20%2B%20(step_values%5B'Fee%20Hike'%5D%20%2F%20100.)%0A%20%20%20%20%20%20%20%20%20%20%20%20_new_fees%20%3D%20old_fees%20*%20(1%20%2B%20price_hike)%0A%20%20%20%20%20%20%20%20%20%20%20%20_evolution%2C%20_latest_ratio%20%3D%20bin_per_point_forecast(baseline_ratio%2C%20baseline_points%2C%20price_hike%2C%20step_values%5B'Year%20Gap'%5D%2B1)%0A%20%20%20%20%20%20%20%20%20%20%20%20_fee_evolution%20%3D%20_evolution%20*%20_new_fees.T%20%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20len(bin_evolution)%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_fee_evolution%5B0%5D%20%3D%20_evolution%5B0%5D%20*%20old_fees.T%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20bin_evolution%20%3D%20_evolution%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fee_evolution%20%3D%20_fee_evolution%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_fee_evolution%20%3D%20_fee_evolution%5B1%3A%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_evolution%20%3D%20_evolution%5B1%3A%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20bin_evolution%20%3D%20np.concatenate(%5Bbin_evolution%2C%20_evolution%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fee_evolution%20%3D%20np.concatenate(%5Bfee_evolution%2C%20_fee_evolution%5D)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20baseline_bins%20%3D%20np.array(%5B_evolution%5B-1%5D%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20baseline_points%20%3D%20(baseline_bins%20%2F%20_latest_ratio.T).T%0A%20%20%20%20%20%20%20%20%20%20%20%20baseline_ratio%20%3D%20_latest_ratio%0A%0A%20%20%20%20%20%20%20%20return%20bin_evolution%2C%20fee_evolution%0A%20%20%20%20return%20bin_per_point_forecast%2C%20stepped_coop%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%23%20Theory%20of%20change%20%0A%0A%20%20%20%20Individual%20payers%20do%20not%20tend%20to%20change%20number%20of%20bins%20(becuase%20they%20almost%20always%20only%20have%20one%20and%20cannot%20not%20have%20trash%20collected)%2C%20they%20alter%20their%20pickup%20frequency.%20%0A%0A%20%20%20%20Coops%20and%20businesses%20can%20work%20with%20the%20number%20of%20bins%20as%20a%20more%20tangible%20way%20of%20saving.%20Reducing%20frequency%20from%203%2Fweek%20to%202%2Fweek%20saves%201%2F3%20of%20costs%2C%20while%20removing%20one%20bin%20when%20you%20have%20two%20bins%20saves%201%2F2%20of%20costs.%20This%20is%20most%20pronounced%20with%20business%20120l%20cans%2C%20and%20to%20a%20lesser%20extent%20with%20standard%201100l%20coop%20cans.%20%0A%0A%20%20%20%20So%20we%20will%20model%20impacts%20of%20fee%2Fschedule%20changes%20this%20way%3A%0A%0A%20%20%20%201.%20For%20individuals%2C%20we%20will%20create%20a%20transition%20matrix%20for%20frequencies%20(most%20common%20ones)%20as%20a%20function%20of%20fee%20change.%20Plus%20more%20custom%20matrices%20when%20we%20will%20model%20changes%20in%20available%20frequencies.%0A%20%20%20%202.%20For%20coops%20and%20businesses%2C%20we%20will%20do%20it%20this%20way%3A%0A%0A%20%20%20%20-%20Create%20a%20function%20that%20converts%20price%20hike%20into%20a%20factor%20for%20decreasing%20bins%20per%20collection%20point%0A%20%20%20%20-%20We%20will%20assume%20that%20frequencies%20will%20not%20change%20unless%20the%20bins%2Fcollection%20point%20should%20drop%20below%201.%20In%20this%20case%2C%20we%20will%20move%20the%20overflow%20(or%20underflow)%20into%20a%20lower%20frequency.%0A%20%20%20%20-%20So%20the%20bins%20per%20collection%20will%20be%20calculated%20on%20a%20per%20interval%20basis%20so%20that%20we%20can%20distribute%20them%20afterwards.%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(np)%3A%0A%20%20%20%20def%20matrix_model_individual(price_increase%3A%20float%20%3D%200.3%2C%20base_scale%3A%20float%20%3D%202.0%2C%20year%3A%20int%20%3D%201%2C%20remove_weekly%3A%20bool%20%3D%20False)%3A%0A%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20the%20matrix%20is%3A%0A%20%20%20%20%20%20%20%20120l%20capacity%2C%201x%20month%0A%20%20%20%20%20%20%20%20120l%20capacity%2C%202x%20month%0A%20%20%20%20%20%20%20%20120l%20capacity%2C%204x%20month%0A%20%20%20%20%20%20%20%20240l%20capacity%2C%202x%20month%0A%20%20%20%20%20%20%20%20240l%20capacity%2C%204x%20month%0A%20%20%20%20%20%20%20%20%22%22%22%0A%0A%20%20%20%20%20%20%20%20factor1%20%3D%20price_increase%20%2F%202%20%0A%20%20%20%20%20%20%20%20factor2%20%3D%20price_increase%20%2F%2015%0A%20%20%20%20%20%20%20%20factor_split%20%3D%20(factor1%20*%200.45%2C%20factor1%20*%200.55)%0A%0A%20%20%20%20%20%20%20%20unit%20%3D%20lambda%20factor%2C%20year%3A%20factor%20%2F%20(base_scale%20**%20year)%0A%0A%20%20%20%20%20%20%20%20monthly_unit%20%3D%201%20-%20unit(factor1%2C%20year)%0A%20%20%20%20%20%20%20%20monthly_split%20%3D%20unit(factor_split%5B0%5D%2C%20year)%2C%20unit(factor_split%5B1%5D%2C%20year)%0A%20%20%20%20%20%20%20%20big_monthly_unit%20%3D%201-unit(factor2%2C%20year)%0A%20%20%20%20%20%20%20%20big_monthly_split%20%3D%20%5B0%2C%200%2C%20unit(factor2%2C%20year)%2C%200%2C%20big_monthly_unit%5D%0A%20%20%20%20%20%20%20%20if%20remove_weekly%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20monthly_unit%20%3D%200%0A%20%20%20%20%20%20%20%20%20%20%20%20big_monthly_unit%20%3D%200%0A%20%20%20%20%20%20%20%20%20%20%20%20monthly_split%20%3D%200.2%2C%200.8%0A%20%20%20%20%20%20%20%20%20%20%20%20big_monthly_split%20%3D%20%5B0.05%2C%200.8%2C%200%2C%200.15%2C%200%5D%0A%0A%20%20%20%20%20%20%20%20matrix%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%5B1%2C0%2C0%2C0%2C0%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5Bunit(factor2%2C%20year)%2C%201-unit(factor2%2C%20year)%2C%200%2C%200%2C%200%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5Bmonthly_split%5B0%5D%2C%20monthly_split%5B1%5D%2C%20monthly_unit%2C%200%2C%200%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5B0%2C%20unit(factor2%2C%20year)%2C%200%2C%201-unit(factor2%2C%20year)%2C%200%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20big_monthly_split%0A%20%20%20%20%20%20%20%20%5D%0A%0A%20%20%20%20%20%20%20%20return%20np.array(matrix)%0A%20%20%20%20return%20(matrix_model_individual%2C)%0A%0A%0A%40app.cell%0Adef%20_(matrix_model_individual%2C%20np)%3A%0A%20%20%20%20def%20run_individual(initial_state%3A%20np.array%2C%20years%3A%20int%20%3D%2010%2C%20current_year%3A%20int%20%3D%200%2C%20**kwargs)%3A%0A%0A%20%20%20%20%20%20%20%20price_increase%20%3D%20kwargs.get('price_increase'%2C0.3)%0A%20%20%20%20%20%20%20%20base_scale%20%3D%20kwargs.get('base_scale'%2C2)%0A%20%20%20%20%20%20%20%20remove_weekly%20%3D%20kwargs.get('remove_weekly'%2C%20False)%0A%0A%20%20%20%20%20%20%20%20if%20current_year%20%3C%20years%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20matrix%20%3D%20matrix_model_individual(price_increase%2C%20base_scale%2C%20current_year%2B1%2C%20remove_weekly)%0A%20%20%20%20%20%20%20%20%20%20%20%20step%20%3D%20np.matmul(matrix.T%2C%20np.array(%5Binitial_state%5B-1%5D%5D).T)%0A%20%20%20%20%20%20%20%20%20%20%20%20history%20%3D%20np.concatenate(%5Binitial_state%2C%20step.T%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20run_individual(history%2C%20years%2C%20current_year%2B1%2C%20**kwargs)%0A%0A%20%20%20%20%20%20%20%20return%20initial_state%0A%20%20%20%20return%20(run_individual%2C)%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A</marimo-code></head>
  <body>
    <div id="root"></div>
    <!-- This is a portal for the data editor to render in -->
    <div id="portal" data-testid="glide-portal" style="position: fixed; left: 0; top: 0; z-index: 9999"></div>
    <script data-marimo="true">
      window.__MARIMO_MOUNT_CONFIG__ = {
            "filename": "notebook.py",
            "mode": "read",
            "version": "0.16.2",
            "serverToken": "unused",
            "config": {"ai": {"models": {"custom_models": [], "displayed_models": []}}, "completion": {"activate_on_typing": true, "copilot": false}, "display": {"cell_output": "above", "code_editor_font_size": 14, "dataframes": "rich", "default_table_max_columns": 50, "default_table_page_size": 10, "default_width": "medium", "reference_highlighting": false, "theme": "light"}, "formatting": {"line_length": 79}, "keymap": {"overrides": {}, "preset": "default"}, "language_servers": {"pylsp": {"enable_flake8": false, "enable_mypy": true, "enable_pydocstyle": false, "enable_pyflakes": false, "enable_pylint": false, "enable_ruff": true, "enabled": true}}, "package_management": {"manager": "pip"}, "runtime": {"auto_instantiate": true, "auto_reload": "off", "default_sql_output": "auto", "on_cell_change": "autorun", "output_max_bytes": 8000000, "reactive_tests": true, "std_stream_max_bytes": 1000000, "watcher_on_save": "lazy"}, "save": {"autosave": "off", "autosave_delay": 1000, "format_on_save": false}, "server": {"browser": "default", "follow_symlink": false}, "snippets": {"custom_paths": [], "include_default_snippets": true}},
            "configOverrides": {},
            "appConfig": {"sql_output": "auto", "width": "medium"},
            "view": {"showAppCode": false},
            "notebook": null,
            "session": null,
            "runtimeConfig": null,
        };
    </script>
  </body>
</html>
